#!/usr/bin/env sh
set -e
mkdir -p build/data

export PGPASSWORD=postgres

if test -e ./env/bin/activate
then
    . ./env/bin/activate
fi

# Determine where to run pg_dump based on environment
if [ -n "$CI" ]; then
  # Running in GitHub Actions CI - find the PostgreSQL service container
  echo "Running in CI environment, detecting PostgreSQL container..."
  POSTGRES_VERSION=${POSTGRES_VERSION:-16}
  CONTAINER=$(docker ps --filter "ancestor=postgres:${POSTGRES_VERSION}" --format "{{.Names}}" | head -1)
  if [ -z "$CONTAINER" ]; then
    echo "ERROR: Could not find PostgreSQL container for version ${POSTGRES_VERSION}"
    docker ps
    exit 1
  fi
  echo "Found PostgreSQL container: $CONTAINER"
  PG_DUMP="docker exec -e PGPASSWORD=postgres $CONTAINER pg_dump"
  PG_DUMP_OUT_PATH="/tmp"
else
  # Running locally - use pg_dump directly
  PG_DUMP="pg_dump"
  PG_DUMP_OUT_PATH="build/data"
fi

if test -f "build/data/dump.not-compressed"; then
  echo "Test data already exists"
else
  pgbench -i -h localhost -U postgres postgres
  psql -h localhost -U postgres -d postgres -q -o /dev/null -f fixtures/schema.sql
  python3 ci/generate-fixture-data.py -U postgres -h localhost  -p 5432 -d postgres

  # Generate dump files (inside container if CI, locally otherwise)
  $PG_DUMP -Fc -h localhost -U postgres -f ${PG_DUMP_OUT_PATH}/dump.not-compressed -d postgres --compress=0
  $PG_DUMP -Fc -h localhost -U postgres -f ${PG_DUMP_OUT_PATH}/dump.compressed -d postgres --compress=9
  $PG_DUMP -Fc -h localhost -U postgres -f ${PG_DUMP_OUT_PATH}/dump.no-data -d postgres --compress=0 -s
  $PG_DUMP -Fc -h localhost -U postgres -f ${PG_DUMP_OUT_PATH}/dump.data-only -d postgres --compress=0 -a
  $PG_DUMP -Fc -h localhost -U postgres -f ${PG_DUMP_OUT_PATH}/dump.inserts -d postgres --compress=0 --inserts

  # If running in CI, copy dump files from container to host
  if [ -n "$CI" ]; then
    echo "Copying dump files from container to host..."
    docker cp $CONTAINER:/tmp/dump.not-compressed build/data/dump.not-compressed
    docker cp $CONTAINER:/tmp/dump.compressed build/data/dump.compressed
    docker cp $CONTAINER:/tmp/dump.no-data build/data/dump.no-data
    docker cp $CONTAINER:/tmp/dump.data-only build/data/dump.data-only
    docker cp $CONTAINER:/tmp/dump.inserts build/data/dump.inserts
  fi
fi
cat > build/test-environment<<EOF
export PGDATABASE=postgres
export PGPASSWORD=postgres
export PGUSER=postgres
export POSTGRES_URI=postgresql://postgres:postgres@localhost:5432/postgres
EOF

# Also create .env file for dotenv loading in tests
cat > .env<<EOF
PGDATABASE=postgres
PGPASSWORD=postgres
PGUSER=postgres
POSTGRES_URI=postgresql://postgres:postgres@localhost:5432/postgres
EOF
